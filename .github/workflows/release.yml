name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release name (e.g., v0.1.0)'
        required: false
        default: 'dev-build'
      create_release:
        description: 'Create GitHub release'
        required: false
        default: 'true'
        type: boolean
      superset_ref:
        description: 'Superset ref (tag/sha). Default: 6.0.0'
        required: false
        default: '6.0.0'

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'
  NPM_VERSION: '10.8.2'
  NODE_OPTIONS: '--max-old-space-size=4096'

jobs:
  build-superset:
    name: Build Superset Frontend & Wheels
    runs-on: ubuntu-latest
    outputs:
      superset_version: ${{ steps.version.outputs.superset_version }}
      app_version: ${{ steps.version.outputs.app_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Ensure npm version
        run: |
          npm --version
          npm i -g "npm@${{ env.NPM_VERSION }}"
          npm --version

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install Python build dependencies
        run: |
          python -m pip install --upgrade pip uv
          uv pip install --system build hatchling

      - name: Pin Superset
        run: |
          SUP_REF="${{ github.event.inputs.superset_ref }}"
          if [ -z "$SUP_REF" ]; then SUP_REF="6.0.0"; fi
          python tools/pin_superset.py --sha "$SUP_REF" --write-version

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: |
            superset-src/superset-frontend/node_modules
            ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('superset-src/superset-frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Build Superset Frontend
        run: |
          cd superset-src/superset-frontend
          npm ci
          npm run build

      - name: Build Superset Wheel
        run: |
          python tools/build_wheels.py --superset-only --output dist/wheels

      - name: Build pyPASreporterGUI Wheel
        run: |
          python tools/build_wheels.py --app-only --output dist/wheels

      - name: Get versions
        id: version
        run: |
          SUPERSET_WHEEL=$(ls dist/wheels/apache_superset-*.whl 2>/dev/null | head -1 || echo "")
          APP_WHEEL=$(ls dist/wheels/pyPASreporterGUI-*.whl 2>/dev/null | head -1 || echo "")

          if [[ -n "$SUPERSET_WHEEL" ]]; then
            SUPERSET_VERSION=$(basename "$SUPERSET_WHEEL" | sed -E 's/apache_superset-([^-]+)-.*/\1/')
          else
            SUPERSET_VERSION="unknown"
          fi

          if [[ -n "$APP_WHEEL" ]]; then
            APP_VERSION=$(basename "$APP_WHEEL" | sed -E 's/pyPASreporterGUI-([^-]+)-.*/\1/')
          else
            APP_VERSION="0.1.0"
          fi

          echo "superset_version=$SUPERSET_VERSION" >> "$GITHUB_OUTPUT"
          echo "app_version=$APP_VERSION" >> "$GITHUB_OUTPUT"

      - name: List built wheels
        run: |
          echo "=== Built Wheels ==="
          ls -la dist/wheels/

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels
          path: dist/wheels/*.whl
          retention-days: 7

  build-linux-exe:
    name: Build Linux Executable
    runs-on: ubuntu-latest
    needs: build-superset

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels
          path: dist/wheels

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install dist/wheels/*.whl

      - name: Verify installation + assets
        run: |
          python -c "from pypasreportergui import __version__; print(f'App Version: {__version__}')"
          python - <<'PY'
          import superset
          from pathlib import Path
          p = Path(superset.__file__).resolve().parent
          print("Superset dir:", p)
          static_assets = p / "static" / "assets"
          templates = p / "templates"
          if not static_assets.exists():
            raise SystemExit(f"ERROR: Missing Superset static assets at: {static_assets}")
          if not templates.exists():
            raise SystemExit(f"ERROR: Missing Superset templates at: {templates}")
          print("OK: Superset assets present.")
          PY

      - name: Build executable
        run: |
          mkdir -p dist/exe
          pyinstaller --clean --noconfirm tools/build_exe.spec
          if [[ -d "dist/pyPASreporterGUI" ]]; then
            mv dist/pyPASreporterGUI dist/exe/
          fi

      - name: Create tarball
        run: |
          cd dist/exe
          tar -czvf pyPASreporterGUI-linux-x64.tar.gz pyPASreporterGUI/
          ls -la

      - name: Upload Linux executable
        uses: actions/upload-artifact@v4
        with:
          name: linux-executable
          path: dist/exe/pyPASreporterGUI-linux-x64.tar.gz
          retention-days: 7

  build-windows-exe:
    name: Build Windows Executable
    runs-on: windows-latest
    needs: build-superset
    if: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels
          path: dist/wheels

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          Get-ChildItem dist/wheels/*.whl | ForEach-Object { pip install $_.FullName }

      - name: Verify installation + assets
        shell: pwsh
        run: |
          python -c "from pypasreportergui import __version__; print(f'App Version: {__version__}')"
          python - <<'PY'
          import superset
          from pathlib import Path
          p = Path(superset.__file__).resolve().parent
          static_assets = p / "static" / "assets"
          templates = p / "templates"
          if not static_assets.exists():
            raise SystemExit(f"ERROR: Missing Superset static assets at: {static_assets}")
          if not templates.exists():
            raise SystemExit(f"ERROR: Missing Superset templates at: {templates}")
          print("OK: Superset assets present.")
          PY

      - name: Build executable
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist/exe | Out-Null
          pyinstaller --clean --noconfirm tools/build_exe.spec
          if (Test-Path "dist/pyPASreporterGUI") {
            Move-Item -Force dist/pyPASreporterGUI dist/exe/
          }

      - name: Create zip
        shell: pwsh
        run: |
          cd dist/exe
          Compress-Archive -Path pyPASreporterGUI -DestinationPath pyPASreporterGUI-windows-x64.zip
          Get-ChildItem

      - name: Upload Windows executable
        uses: actions/upload-artifact@v4
        with:
          name: windows-executable
          path: dist/exe/pyPASreporterGUI-windows-x64.zip
          retention-days: 7

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-superset, build-linux-exe]
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          cp artifacts/wheels/*.whl release-assets/ || true
          cp artifacts/linux-executable/*.tar.gz release-assets/ || true
          ls -la release-assets/

      - name: Determine release tag
        id: release_tag
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="${{ github.event.inputs.release_name }}"
            if [[ "$TAG" == "dev-build" ]]; then
              TAG="dev-$(date +%Y%m%d-%H%M%S)"
            fi
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          name: "pyPASreporterGUI ${{ steps.release_tag.outputs.tag }}"
          body: |
            ## pyPASreporterGUI Release ${{ steps.release_tag.outputs.tag }}

            ### Downloads
            - Wheels: `*.whl`
            - Linux: `pyPASreporterGUI-linux-x64.tar.gz`

            ### Build Info
            - Python: ${{ env.PYTHON_VERSION }}
            - Node.js: ${{ env.NODE_VERSION }}
            - npm: ${{ env.NPM_VERSION }}
            - Superset: ${{ needs.build-superset.outputs.superset_version }}
            - App Version: ${{ needs.build-superset.outputs.app_version }}
          files: release-assets/*
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/v') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
